name: Manual Release

# æ‰‹åŠ¨è§¦å‘å‘å¸ƒæµç¨‹

permissions:
  contents: write
  id-token: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.1)'
        required: true
        type: string
      test_first:
        description: 'Test on TestPyPI first'
        required: false
        default: true
        type: boolean
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: true
        type: boolean

jobs:
  manual-release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Update version
      run: |
        python << 'EOF'
        import re
        
        version = "${{ github.event.inputs.version }}"
        
        # æ›´æ–° pyproject.toml
        with open('pyproject.toml', 'r') as f:
            content = f.read()
        content = re.sub(r'version = "[^"]+"', f'version = "{version}"', content)
        with open('pyproject.toml', 'w') as f:
            f.write(content)
        
        # æ›´æ–° __init__.py
        with open('__init__.py', 'r') as f:
            content = f.read()
        content = re.sub(r'__version__ = "[^"]+"', f'__version__ = "{version}"', content)
        with open('__init__.py', 'w') as f:
            f.write(content)
        
        print(f"Version updated to: {version}")
        EOF
    
    - name: Commit version update
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add pyproject.toml __init__.py
        git commit -m "Release version ${{ github.event.inputs.version }}"
        git push
    
    - name: Build package
      run: |
        python -m build
        echo "Built packages:"
        ls -la dist/
    
    - name: Check package
      run: |
        python -m twine check dist/*
    
    - name: Test publish to TestPyPI
      if: github.event.inputs.test_first == 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        echo "Publishing to TestPyPI..."
        python -m twine upload --repository testpypi dist/* --verbose
        echo "âœ… Successfully published to TestPyPI"
        echo "Test installation: pip install --index-url https://test.pypi.org/simple/ heventure-search-mcp==${{ github.event.inputs.version }}"
    
    - name: Wait before PyPI
      if: github.event.inputs.test_first == 'true'
      run: |
        echo "Waiting 30 seconds before publishing to PyPI..."
        sleep 30
    
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "Publishing to PyPI..."
        python -m twine upload dist/* --verbose
        echo "âœ… Successfully published to PyPI"
        echo "Install with: pip install heventure-search-mcp==${{ github.event.inputs.version }}"
    
    - name: Create Git Tag
      run: |
        git tag v${{ github.event.inputs.version }}
        git push origin v${{ github.event.inputs.version }}
    
    - name: Create GitHub Release
      if: github.event.inputs.create_release == 'true'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.event.inputs.version }}
        release_name: Release v${{ github.event.inputs.version }}
        body: |
          ## ğŸš€ ç‰ˆæœ¬ ${{ github.event.inputs.version }}
          
          ### ğŸ“¦ å®‰è£…æ–¹å¼
          ```bash
          pip install heventure-search-mcp==${{ github.event.inputs.version }}
          ```
          
          æˆ–ä½¿ç”¨ uvxï¼š
          ```bash
          uvx heventure-search-mcp
          ```
          
          ### ğŸ”— é“¾æ¥
          - [PyPI é¡µé¢](https://pypi.org/project/heventure-search-mcp/${{ github.event.inputs.version }}/)
          - [GitHub ä»“åº“](https://github.com/${{ github.repository }})
          - [æ–‡æ¡£](https://github.com/${{ github.repository }}#readme)
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) è·å–è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          
          ### ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•
          
          #### ä½œä¸º MCP æœåŠ¡å™¨
          ```bash
          heventure-search-mcp
          ```
          
          #### ç¼–ç¨‹æ–¹å¼ä½¿ç”¨
          ```python
          from server import WebSearcher
          
          searcher = WebSearcher()
          results = await searcher.search("Python MCP")
          ```
          
          ---
          
          æ„Ÿè°¢ä½¿ç”¨ heventure-search-mcpï¼å¦‚æœ‰é—®é¢˜è¯·æäº¤ Issueã€‚
        draft: false
        prerelease: false
    
    - name: Summary
      run: |
        echo "ğŸ‰ Release ${{ github.event.inputs.version }} completed successfully!"
        echo ""
        echo "ğŸ“¦ Package: https://pypi.org/project/heventure-search-mcp/${{ github.event.inputs.version }}/"
        echo "ğŸ·ï¸ Release: https://github.com/${{ github.repository }}/releases/tag/v${{ github.event.inputs.version }}"
        echo ""
        echo "Install with:"
        echo "  pip install heventure-search-mcp==${{ github.event.inputs.version }}"
        echo "  uvx heventure-search-mcp"