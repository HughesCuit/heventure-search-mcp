name: Auto Publish to PyPI

# å½“ä»£ç æ›´æ–°æ—¶è‡ªåŠ¨å‘å¸ƒåˆ°PyPIå¹¶æ›´æ–°ç‰ˆæœ¬å·
on:
  push:
    branches: [ main ]
    paths:
      - 'server.py'
      - 'pyproject.toml'
      - 'setup.py'
      - '__init__.py'
      - '*.py'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      skip_tests:
        description: 'Skip tests and publish directly'
        required: false
        default: false
        type: boolean

jobs:
  # ç‰ˆæœ¬æ£€æŸ¥å’Œæ›´æ–°
  version-check:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.version-check.outputs.should_publish }}
      new_version: ${{ steps.version-check.outputs.new_version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install packaging requests
    
    - name: Check and update version
      id: version-check
      run: |
        python << 'EOF'
        import re
        import subprocess
        import sys
        from packaging import version
        import requests
        import os
        
        def get_current_version():
            with open('pyproject.toml', 'r') as f:
                content = f.read()
            match = re.search(r'version = "([^"]+)"', content)
            return match.group(1) if match else None
        
        def get_pypi_version():
            try:
                response = requests.get('https://pypi.org/pypi/heventure-search-mcp/json')
                if response.status_code == 200:
                    return response.json()['info']['version']
            except:
                pass
            return None
        
        def bump_version(current_ver, bump_type):
            v = version.parse(current_ver)
            if bump_type == 'major':
                return f"{v.major + 1}.0.0"
            elif bump_type == 'minor':
                return f"{v.major}.{v.minor + 1}.0"
            else:  # patch
                return f"{v.major}.{v.minor}.{v.micro + 1}"
        
        def update_version_in_files(new_ver):
            # æ›´æ–° pyproject.toml
            with open('pyproject.toml', 'r') as f:
                content = f.read()
            content = re.sub(r'version = "[^"]+"', f'version = "{new_ver}"', content)
            with open('pyproject.toml', 'w') as f:
                f.write(content)
            
            # æ›´æ–° __init__.py
            with open('__init__.py', 'r') as f:
                content = f.read()
            content = re.sub(r'__version__ = "[^"]+"', f'__version__ = "{new_ver}"', content)
            with open('__init__.py', 'w') as f:
                f.write(content)
        
        current_version = get_current_version()
        pypi_version = get_pypi_version()
        
        print(f"Current version: {current_version}")
        print(f"PyPI version: {pypi_version}")
        
        # ç¡®å®šç‰ˆæœ¬æ›´æ–°ç±»å‹
        version_type = os.environ.get('VERSION_TYPE', 'patch')
        if '${{ github.event.inputs.version_type }}' != '':
            version_type = '${{ github.event.inputs.version_type }}'
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒ
        should_publish = False
        new_version = current_version
        
        if pypi_version is None:
            # é¦–æ¬¡å‘å¸ƒ
            should_publish = True
            print("First time publishing to PyPI")
        elif version.parse(current_version) <= version.parse(pypi_version):
            # éœ€è¦æ›´æ–°ç‰ˆæœ¬
            new_version = bump_version(current_version, version_type)
            update_version_in_files(new_version)
            should_publish = True
            print(f"Version bumped to: {new_version}")
        else:
            # å½“å‰ç‰ˆæœ¬å·²ç»æ¯”PyPIç‰ˆæœ¬æ–°
            should_publish = True
            print(f"Current version {current_version} is newer than PyPI {pypi_version}")
        
        # è®¾ç½®è¾“å‡º
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"should_publish={str(should_publish).lower()}\n")
            f.write(f"new_version={new_version}\n")
        EOF
    
    - name: Commit version changes
      if: steps.version-check.outputs.should_publish == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add pyproject.toml __init__.py
        if git diff --staged --quiet; then
          echo "No version changes to commit"
        else
          git commit -m "Bump version to ${{ steps.version-check.outputs.new_version }}"
          git push
        fi

  # æ„å»ºå’Œå‘å¸ƒ
  publish:
    needs: version-check
    if: needs.version-check.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: main  # ç¡®ä¿è·å–æœ€æ–°çš„ç‰ˆæœ¬æ›´æ–°
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Build package
      run: |
        python -m build
    
    - name: Check package
      run: |
        python -m twine check dist/*
    
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        echo "ğŸš€ Publishing to PyPI..."
        python -m twine upload dist/* --verbose
        echo "âœ… Successfully published to PyPI!"
        echo "ğŸ“¦ Install with: pip install heventure-search-mcp==${{ needs.version-check.outputs.new_version }}"
    
    - name: Create Git Tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag v${{ needs.version-check.outputs.new_version }}
        git push origin v${{ needs.version-check.outputs.new_version }}
        echo "ğŸ·ï¸ Created tag v${{ needs.version-check.outputs.new_version }}"
    
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.version-check.outputs.new_version }}
        release_name: Release v${{ needs.version-check.outputs.new_version }}
        body: |
          ## ğŸš€ ç‰ˆæœ¬ ${{ needs.version-check.outputs.new_version }}
          
          ### ğŸ“¦ å®‰è£…æ–¹å¼
          ```bash
          pip install heventure-search-mcp==${{ needs.version-check.outputs.new_version }}
          ```
          
          æˆ–ä½¿ç”¨ uvxï¼š
          ```bash
          uvx heventure-search-mcp
          ```
          
          ### ğŸ”— é“¾æ¥
          - [PyPI é¡µé¢](https://pypi.org/project/heventure-search-mcp/${{ needs.version-check.outputs.new_version }}/)
          - [GitHub ä»“åº“](https://github.com/${{ github.repository }})
          - [ä½¿ç”¨æ–‡æ¡£](https://github.com/${{ github.repository }}#readme)
          
          ### ğŸ“‹ æ›´æ–°å†…å®¹
          æ­¤ç‰ˆæœ¬é€šè¿‡è‡ªåŠ¨åŒ–æµç¨‹å‘å¸ƒï¼ŒåŒ…å«æœ€æ–°çš„ä»£ç æ›´æ–°ã€‚
          
          è¯¦ç»†æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)ã€‚
          
          ### ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•
          
          #### ä½œä¸º MCP æœåŠ¡å™¨
          ```bash
          heventure-search-mcp
          ```
          
          #### ç¼–ç¨‹æ–¹å¼ä½¿ç”¨
          ```python
          from server import WebSearcher
          
          searcher = WebSearcher()
          results = await searcher.search("Python MCP")
          ```
          
          ---
          
          ğŸ¤– æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨å‘å¸ƒ
        draft: false
        prerelease: false
    
    - name: Update CHANGELOG
      run: |
        echo "ğŸ“ Updating CHANGELOG..."
        python << 'EOF'
        import re
        from datetime import datetime
        
        version = "${{ needs.version-check.outputs.new_version }}"
        today = datetime.now().strftime("%Y-%m-%d")
        
        try:
            with open('CHANGELOG.md', 'r') as f:
                content = f.read()
            
            # åœ¨ [Unreleased] éƒ¨åˆ†åæ·»åŠ æ–°ç‰ˆæœ¬
            unreleased_pattern = r'(## \[Unreleased\].*?)(\n## \[)'
            new_section = f"\n\n## [{version}] - {today}\n\n### Changed\n- è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ {version}\n- åŒ…å«æœ€æ–°ä»£ç æ›´æ–°\n"
            
            if re.search(unreleased_pattern, content, re.DOTALL):
                content = re.sub(unreleased_pattern, f"\\1{new_section}\\2", content, flags=re.DOTALL)
            else:
                # å¦‚æœæ²¡æœ‰æ‰¾åˆ° Unreleased éƒ¨åˆ†ï¼Œåœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ 
                content = f"# Changelog\n\n## [Unreleased]\n{new_section}\n" + content
            
            with open('CHANGELOG.md', 'w') as f:
                f.write(content)
            
            print(f"âœ… CHANGELOG updated with version {version}")
        except Exception as e:
            print(f"âš ï¸ Failed to update CHANGELOG: {e}")
        EOF
        
        # æäº¤CHANGELOGæ›´æ–°
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add CHANGELOG.md
        if git diff --staged --quiet; then
          echo "No CHANGELOG changes to commit"
        else
          git commit -m "ğŸ“ Update CHANGELOG for version ${{ needs.version-check.outputs.new_version }}"
          git push
        fi
    
    - name: Publish Summary
      run: |
        echo "ğŸ‰ å‘å¸ƒå®Œæˆï¼"
        echo ""
        echo "ğŸ“¦ åŒ…ä¿¡æ¯:"
        echo "  - ç‰ˆæœ¬: ${{ needs.version-check.outputs.new_version }}"
        echo "  - PyPI: https://pypi.org/project/heventure-search-mcp/${{ needs.version-check.outputs.new_version }}/"
        echo "  - GitHub Release: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version-check.outputs.new_version }}"
        echo ""
        echo "ğŸš€ å®‰è£…å‘½ä»¤:"
        echo "  pip install heventure-search-mcp==${{ needs.version-check.outputs.new_version }}"
        echo "  uvx heventure-search-mcp"
        echo ""
        echo "âœ¨ è‡ªåŠ¨å‘å¸ƒæµç¨‹å·²å®Œæˆï¼"